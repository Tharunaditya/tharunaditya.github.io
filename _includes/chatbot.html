<!-- Cyberpunk Glass Chatbot Widget -->
<div class="chat-widget-container">
    <!-- Floating Action Button -->
    <button id="chat-toggle-btn" class="chat-toggle-btn" aria-label="Open AI Assistant">
        <i class="fas fa-robot"></i>
        <div class="chat-pulse-ring"></div>
    </button>

    <!-- Chat Interface -->
    <div id="chat-interface" class="chat-interface hidden">
        <div class="chat-header">
            <div class="chat-header-info">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h3 class="chat-title">SecBot v1.0</h3>
                    <span class="chat-status">‚óè Online</span>
                </div>
            </div>
            <div class="chat-controls" style="display: flex; gap: 8px;">
                <button id="chat-size-btn" class="chat-size-btn" title="Resize Chat">1x</button>
                <button id="chat-close-btn" class="chat-close-btn">&times;</button>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            <!-- Initial Greeting -->
            <div class="message bot-message">
                <div class="message-content">
                    <p>Greetings. I am <strong>SecBot</strong>.</p>
                    <p>I have indexed all <strong>{{ site.posts.size }}</strong> security articles on this blog. Ask me about Microarchitecture, AI Injection, or Buffer Overflows.</p>
                </div>
                <span class="message-time">Now</span>
            </div>
        </div>

        <div class="chat-input-area">
            <form id="chat-form" onsubmit="handleChatSubmit(event)">
                <input type="text" id="chat-input" placeholder="Ask about cybersecurity..." autocomplete="off">
                <button type="submit" class="chat-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Capture Page Context for the Bot
    const pageContext = {
        title: "{{ page.title | default: site.title | escape }}",
        // detailed content for specific article queries
        content: "{{ page.content | strip_html | strip_newlines | escape | truncate: 1500 }}" 
    };

    const chatToggle = document.getElementById('chat-toggle-btn');
    const chatInterface = document.getElementById('chat-interface');
    const chatClose = document.getElementById('chat-close-btn');
    const chatSizeBtn = document.getElementById('chat-size-btn');
    const chatMessages = document.getElementById('chat-messages');

    // Resizing Logic
    let currentSize = 1;
    chatSizeBtn.addEventListener('click', () => {
        currentSize++;
        if (currentSize > 3) currentSize = 1;
        
        chatInterface.classList.remove('size-1x', 'size-2x', 'size-3x');
        chatInterface.classList.add(`size-${currentSize}x`);
        chatSizeBtn.textContent = `${currentSize}x`;
    });

    // Toggle Chat
    chatToggle.addEventListener('click', () => {
        chatInterface.classList.toggle('hidden');
        chatInterface.classList.toggle('visible');
        if (chatInterface.classList.contains('visible')) {
            document.getElementById('chat-input').focus();
        }
    });

    chatClose.addEventListener('click', () => {
        chatInterface.classList.remove('visible');
        chatInterface.classList.add('hidden');
    });

    // Real Chat Functionality
    async function handleChatSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        
        if (!text) return;

        // Add User Message
        appendMessage('user', text);
        input.value = '';

        // Show Typing Indicator
        showTypingIndicator();

        try {
            // Call the Cloudflare Worker
            const response = await fetch('https://secbot-proxy.anuganti9.workers.dev', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message: text,
                    context: pageContext // Send the current article info
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            
            // Expected OpenAI-compatible format: data.choices[0].message.content
            const botReply = data.choices && data.choices[0] && data.choices[0].message 
                ? data.choices[0].message.content 
                : "Security breach detected in communication protocol. (API Error)";

            removeTypingIndicator();
            appendMessage('bot', formatBotResponse(botReply));

        } catch (error) {
            console.error('Error:', error);
            removeTypingIndicator();
            appendMessage('bot', "Connection failed. The secure line is down.");
        }
    }

    // formatting for code blocks and new lines
    function formatBotResponse(text) {
        // Simple sanitization and formatting
        // Convert newlines to <br>
        let formatted = text.replace(/\n/g, '<br>');
        // Convert **bold** to <strong>
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Convert `code` to <code>
        formatted = formatted.replace(/`(.*?)`/g, '<code style="background: rgba(0, 255, 65, 0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
        return formatted;
    }

    function appendMessage(sender, text) {
        const div = document.createElement('div');
        div.className = `message ${sender}-message`;
        div.innerHTML = `
            <div class="message-content"><p>${text}</p></div>
            <span class="message-time">Just now</span>
        `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
        const div = document.createElement('div');
        div.id = 'typing-indicator';
        div.className = 'message bot-message typing';
        div.innerHTML = `
            <div class="message-content">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        const el = document.getElementById('typing-indicator');
        if (el) el.remove();
    }
</script>